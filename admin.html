<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Segural | Admin</title>

  <style>
    :root{
      --bg:#ffffff; --muted:#f4f6f8; --text:#101828; --sub:#475467; --line:#e4e7ec;
      --blue:#2b6cb0; --blue2:#0b63ce; --shadow:0 10px 30px rgba(16,24,40,.10); --r:18px;
      --danger:#b42318; --dangerBg: rgba(180,35,24,.08);
      --ok:#027a48; --okBg: rgba(2,122,72,.10);
      --offer:#b54708; --offerBg: rgba(181,71,8,.12);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{
      position:sticky;top:0;z-index:1000;background:rgba(255,255,255,.92);backdrop-filter:blur(10px);
      border-bottom:1px solid var(--line);box-shadow:0 6px 20px rgba(16,24,40,.06);
    }
    .nav-wrap{max-width:1150px;margin:0 auto;padding:14px 18px;display:flex;align-items:center;justify-content:space-between;gap:14px}
    .brand{display:flex;align-items:center;gap:10px;text-decoration:none;color:var(--text);font-weight:800;font-size:20px}
    .brand-badge{width:40px;height:40px;border-radius:14px;background:linear-gradient(135deg,var(--blue),#1f3c88);
      box-shadow:0 10px 20px rgba(43,108,176,.25);display:grid;place-items:center;color:#fff;font-weight:900}
    nav{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .nav-link{text-decoration:none;color:var(--sub);padding:10px 12px;border-radius:12px;border:1px solid transparent;transition:.2s ease;font-weight:700;font-size:14px}
    .nav-link:hover{color:var(--text);background:var(--muted);border-color:var(--line)}
    .nav-link.primary{color:#fff;background:linear-gradient(135deg,var(--blue2),var(--blue));border-color:rgba(43,108,176,.25);box-shadow:0 10px 20px rgba(11,99,206,.20)}

    .container{max-width:1150px;margin:0 auto;padding:26px 18px 90px}

    .topbar{
      display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between;
      padding:18px;border:1px solid var(--line);border-radius:var(--r);
      background:linear-gradient(180deg,#ffffff,#fafbfc);box-shadow:0 10px 25px rgba(16,24,40,.06);
    }
    .topbar h1{margin:0 0 6px 0;font-size:22px}
    .topbar p{margin:0;color:var(--sub);line-height:1.6}
    .top-actions{display:flex;gap:10px;flex-wrap:wrap;align-items:center}

    .btn{
      display:inline-flex;align-items:center;gap:10px;
      padding:12px 14px;border-radius:14px;border:1px solid rgba(11,99,206,.20);
      background:rgba(11,99,206,.08);color:var(--blue2);
      font-weight:900;cursor:pointer;transition:.2s ease;text-decoration:none;
    }
    .btn:hover{transform:translateY(-1px);filter:brightness(1.02)}
    .btn.primary{background:linear-gradient(135deg,var(--blue2),var(--blue));color:#fff;border-color:rgba(43,108,176,.25);box-shadow:0 10px 20px rgba(11,99,206,.18)}
    .btn.danger{background:var(--dangerBg);border-color:rgba(180,35,24,.25);color:var(--danger)}
    .btn.ok{background:var(--okBg);border-color:rgba(2,122,72,.25);color:var(--ok)}
    .btn.ghost{background:#fff;border-color:var(--line);color:var(--text)}
    .btn.small{padding:9px 10px;border-radius:12px;font-weight:900;font-size:13px}

    .list{margin-top:18px;display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .item{grid-column:span 6;border:1px solid var(--line);border-radius:16px;padding:14px;background:#fff;box-shadow:0 10px 25px rgba(16,24,40,.06)}
    .item-top{display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
    .item h3{margin:0 0 6px 0;font-size:16px}
    .item p{margin:0;color:var(--sub);line-height:1.55;font-size:13.5px}
    .tag{display:inline-block;margin-top:8px;padding:6px 10px;border-radius:999px;background:var(--muted);border:1px solid var(--line);font-weight:900;font-size:12px;color:#344054}
    .tag.offer{background:var(--offerBg);border-color:rgba(181,71,8,.25);color:var(--offer)}
    .item .actions{margin-top:12px;display:flex;gap:10px;flex-wrap:wrap}

    .thumbs{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap}
    .thumbs img{width:72px;height:54px;object-fit:cover;border-radius:12px;border:1px solid var(--line);background:var(--muted)}

    .note{
      margin-top:14px;padding:14px 16px;border-radius:16px;background:var(--muted);
      border:1px solid var(--line);color:var(--sub);line-height:1.6;font-weight:800;
    }

    /* MODAL */
    .modal-backdrop{
      position:fixed;inset:0;background:rgba(16,24,40,.55);
      display:none;align-items:center;justify-content:center;z-index:99999;padding:16px;
    }
    .modal{
      width:min(920px, 100%);
      background:#fff;border-radius:18px;box-shadow:var(--shadow);
      border:1px solid rgba(255,255,255,.20);overflow:hidden;
    }
    .modal-head{
      padding:14px 16px;border-bottom:1px solid var(--line);
      background:linear-gradient(180deg,#ffffff,#fafbfc);
      display:flex;align-items:center;justify-content:space-between;gap:12px;
    }
    .modal-head h2{margin:0;font-size:18px}
    .modal-body{padding:16px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .field{grid-column:span 6}
    .field.full{grid-column:span 12}
    label{display:block;font-weight:900;font-size:13px;margin:0 0 6px}
    input,select,textarea{
      width:100%;padding:12px;border-radius:14px;border:1px solid var(--line);
      outline:none;background:#fff;box-shadow:0 6px 16px rgba(16,24,40,.05);font-family:inherit
    }
    textarea{min-height:90px;resize:vertical}
    .hint{font-size:12.5px;color:var(--sub);line-height:1.5;margin-top:6px}

    .gallery{
      display:flex;gap:10px;flex-wrap:wrap;
      padding:12px;border:1px solid var(--line);border-radius:16px;background:var(--muted);
      align-items:center;
    }
    .ph{
      width:86px;height:64px;border-radius:12px;border:1px dashed var(--line);
      display:grid;place-items:center;color:var(--sub);font-weight:900;background:#fff;
    }
    .gimg{position:relative;width:86px;height:64px;border-radius:12px;overflow:hidden;border:1px solid var(--line);background:#fff}
    .gimg img{width:100%;height:100%;object-fit:cover}
    .gimg button{
      position:absolute;top:6px;right:6px;width:26px;height:26px;border-radius:999px;border:none;
      background:rgba(180,35,24,.92);color:#fff;font-weight:900;cursor:pointer;
    }

    .modal-foot{
      padding:14px 16px;border-top:1px solid var(--line);
      display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;background:#fff;
    }
    .file-row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .file-row input[type="file"]{padding:10px}
    .toggle{
      display:flex;align-items:center;gap:10px;padding:12px;border:1px solid var(--line);
      border-radius:14px;background:#fff;box-shadow:0 6px 16px rgba(16,24,40,.05);
    }
    .toggle input{width:18px;height:18px}
    .toggle span{font-weight:900;color:#344054}

    .hidden{display:none !important}
    @media (max-width:860px){.item{grid-column:span 12}.field{grid-column:span 12}}
  </style>
</head>

<body>
  <header>
    <div class="nav-wrap">
      <a class="brand" href="index.html">
        <span class="brand-badge">S</span><span>Segural</span>
      </a>
      <nav>
        <a class="nav-link" href="index.html">Inicio</a>
        <a class="nav-link" href="productos.html">Productos</a>
        <a class="nav-link primary" href="admin.html">Admin</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="topbar">
      <div>
        <h1>Panel Admin</h1>
        <p>Modal + varias imágenes + exportar/importar + <b>OFERTAS</b>.</p>
      </div>

      <div class="top-actions">
        <button class="btn primary" id="btnOpenModal" type="button">＋ Agregar producto</button>
        <button class="btn ok" id="btnExport" type="button">Exportar</button>
        <button class="btn" id="btnImport" type="button">Importar</button>
        <input class="hidden" id="importFile" type="file" accept="application/json" />
        <button class="btn danger" id="btnWipe" type="button">Borrar todo</button>
      </div>
    </section>

    <div class="note">
      Para no perder tus productos: <b>Exportar</b> guarda un archivo. <b>Importar</b> lo restaura en cualquier PC/navegador.
    </div>

    <div id="list" class="list"></div>
  </main>

  <!-- MODAL -->
  <div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-head">
        <h2 id="modalTitle">Agregar producto</h2>
        <button class="btn ghost small" id="btnCloseModal" type="button">Cerrar ✕</button>
      </div>

      <div class="modal-body">
        <form id="form">
          <div class="grid">
            <div class="field">
              <label for="nombre">Nombre</label>
              <input id="nombre" required placeholder="Ej: Cámara IP WiFi 1080p" />
            </div>

            <div class="field">
              <label for="categoria">Categoría</label>
              <select id="categoria" required>
                <option value="Alarmas">Alarmas</option>
                <option value="Cámaras">Cámaras</option>
                <option value="Porteros">Porteros</option>
                <option value="Portones">Equipos de portones</option>
                <option value="Otros">Otros</option>
              </select>
            </div>

            <div class="field">
              <label for="precio">Precio (opcional)</label>
              <input id="precio" type="number" min="0" step="1" placeholder="Dejar vacío = Consultar precio" />
              <div class="hint">Si queda vacío, aparece “Consultar precio”.</div>
            </div>

            <div class="field">
              <label>Promoción</label>
              <div class="toggle">
                <input id="oferta" type="checkbox" />
                <span>Marcar como OFERTA</span>
              </div>
              <div class="hint">En la tienda se mostrará una etiqueta “OFERTA”.</div>
            </div>

            <div class="field">
              <label>Imágenes (podés subir varias)</label>
              <div class="file-row">
                <input id="imgFiles" type="file" accept="image/*" multiple />
                <button class="btn small" id="btnClearImgs" type="button">Limpiar imágenes</button>
              </div>
              <div class="hint">Recomendado: imágenes livianas (&lt; 2MB cada una).</div>
            </div>

            <div class="field full">
              <label>Galería (vista previa)</label>
              <div class="gallery" id="gallery"></div>
            </div>

            <div class="field full">
              <label for="descripcion">Descripción (opcional)</label>
              <textarea id="descripcion" placeholder="Características, instalación, detalles..."></textarea>
            </div>
          </div>
        </form>
      </div>

      <div class="modal-foot">
        <button class="btn ghost" id="btnCancel" type="button">Cancelar</button>
        <button class="btn primary" id="btnSave" type="button">Guardar</button>
      </div>
    </div>
  </div>

  <script>
    // ====== STORAGE (con migración automática) ======
    const STORAGE_KEY = "segural_products_v3";
    const LEGACY_KEYS = ["segural_products_v2", "segural_products_v1"];

    function safeParse(raw){
      try { return raw ? JSON.parse(raw) : []; } catch { return []; }
    }

    function uid(){
      if (crypto && crypto.randomUUID) return crypto.randomUUID();
      return String(Date.now()) + Math.random().toString(16).slice(2);
    }

    function normalizeProduct(obj){
      const imagenes = Array.isArray(obj.imagenes) ? obj.imagenes : (obj.imagen ? [obj.imagen] : []);
      return {
        id: obj.id || uid(),
        nombre: String(obj.nombre || "").trim(),
        categoria: String(obj.categoria || "Otros"),
        precio: (obj.precio === "" || obj.precio === null || obj.precio === undefined) ? "" : Number(obj.precio),
        descripcion: String(obj.descripcion || ""),
        imagenes: imagenes.filter(Boolean),
        oferta: !!obj.oferta,
        createdAt: obj.createdAt || Date.now()
      };
    }

    function loadAllProducts(){
      const v3 = safeParse(localStorage.getItem(STORAGE_KEY));
      if (Array.isArray(v3) && v3.length) return v3;

      for (const k of LEGACY_KEYS){
        const legacy = safeParse(localStorage.getItem(k));
        if (Array.isArray(legacy) && legacy.length){
          const migrated = legacy.map(normalizeProduct).filter(p => p.nombre);
          localStorage.setItem(STORAGE_KEY, JSON.stringify(migrated));
          return migrated;
        }
      }
      return [];
    }

    function saveAllProducts(arr){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
    }

    // ====== UI refs ======
    const $list = document.getElementById("list");

    const $btnOpenModal = document.getElementById("btnOpenModal");
    const $btnCloseModal = document.getElementById("btnCloseModal");
    const $btnCancel = document.getElementById("btnCancel");
    const $modalBackdrop = document.getElementById("modalBackdrop");
    const $modalTitle = document.getElementById("modalTitle");

    const $btnExport = document.getElementById("btnExport");
    const $btnImport = document.getElementById("btnImport");
    const $importFile = document.getElementById("importFile");
    const $btnWipe = document.getElementById("btnWipe");

    const $form = document.getElementById("form");
    const $nombre = document.getElementById("nombre");
    const $categoria = document.getElementById("categoria");
    const $precio = document.getElementById("precio");
    const $descripcion = document.getElementById("descripcion");
    const $oferta = document.getElementById("oferta");

    const $imgFiles = document.getElementById("imgFiles");
    const $btnClearImgs = document.getElementById("btnClearImgs");
    const $gallery = document.getElementById("gallery");
    const $btnSave = document.getElementById("btnSave");

    let editId = null;
    let images = [];

    function moneyARS(value){
      const n = Number(value || 0);
      return n.toLocaleString("es-AR", { style: "currency", currency: "ARS", maximumFractionDigits: 0 });
    }

    function openModal(mode){
      $modalBackdrop.style.display = "flex";
      $modalBackdrop.setAttribute("aria-hidden", "false");
      document.body.style.overflow = "hidden";
      $modalTitle.textContent = (mode === "edit") ? "Editar producto" : "Agregar producto";
      setTimeout(() => $nombre.focus(), 50);
    }

    function closeModal(){
      $modalBackdrop.style.display = "none";
      $modalBackdrop.setAttribute("aria-hidden", "true");
      document.body.style.overflow = "";
      resetForm();
    }

    function resetForm(){
      editId = null;
      images = [];
      $form.reset();
      $categoria.value = "Alarmas";
      $imgFiles.value = "";
      renderGallery();
    }

    function renderGallery(){
      $gallery.innerHTML = "";
      if(!images.length){
        const ph = document.createElement("div");
        ph.className = "ph";
        ph.textContent = "Sin imágenes";
        $gallery.appendChild(ph);
        return;
      }
      images.forEach((src, idx) => {
        const wrap = document.createElement("div");
        wrap.className = "gimg";
        const img = document.createElement("img");
        img.src = src;
        img.alt = "Imagen " + (idx+1);
        const del = document.createElement("button");
        del.type = "button";
        del.textContent = "×";
        del.title = "Quitar";
        del.onclick = () => { images.splice(idx,1); renderGallery(); };
        wrap.appendChild(img);
        wrap.appendChild(del);
        $gallery.appendChild(wrap);
      });
    }

    function fileToDataUrl(file){
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(String(reader.result || ""));
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    function validateImage(file){
      const maxMB = 2.2;
      const sizeMB = file.size / (1024 * 1024);
      return sizeMB <= maxMB;
    }

    $imgFiles.addEventListener("change", async () => {
      const files = Array.from($imgFiles.files || []);
      if(!files.length) return;

      for(const f of files){
        if(!validateImage(f)){
          alert("Una imagen es muy grande. Usá imágenes más livianas (ideal < 2MB).");
          continue;
        }
        const data = await fileToDataUrl(f);
        images.push(data);
      }
      renderGallery();
      $imgFiles.value = "";
    });

    $btnClearImgs.addEventListener("click", () => {
      images = [];
      renderGallery();
      $imgFiles.value = "";
    });

    $btnOpenModal.addEventListener("click", () => { resetForm(); openModal("add"); });
    $btnCloseModal.addEventListener("click", closeModal);
    $btnCancel.addEventListener("click", closeModal);

    $modalBackdrop.addEventListener("click", (e) => { if(e.target === $modalBackdrop) closeModal(); });
    window.addEventListener("keydown", (e) => { if(e.key === "Escape" && $modalBackdrop.style.display === "flex") closeModal(); });

    function renderList(){
      const arr = loadAllProducts();
      $list.innerHTML = "";

      if(!arr.length){
        const div = document.createElement("div");
        div.style.gridColumn = "span 12";
        div.style.padding = "14px";
        div.style.border = "1px solid var(--line)";
        div.style.borderRadius = "16px";
        div.style.background = "var(--muted)";
        div.style.color = "var(--sub)";
        div.style.fontWeight = "900";
        div.textContent = "No hay productos. Usá “＋ Agregar producto”.";
        $list.appendChild(div);
        return;
      }

      for(const p of arr){
        const item = document.createElement("div");
        item.className = "item";

        const top = document.createElement("div");
        top.className = "item-top";

        const left = document.createElement("div");
        const h3 = document.createElement("h3");
        h3.textContent = p.nombre || "Producto";

        const priceTxt = p.precio ? moneyARS(p.precio) : "Consultar precio";
        const info = document.createElement("p");
        info.textContent = `${priceTxt} • ${p.descripcion || "Sin descripción"}`;

        const tag = document.createElement("span");
        tag.className = "tag";
        tag.textContent = p.categoria || "Sin categoría";

        left.appendChild(h3);
        left.appendChild(info);
        left.appendChild(tag);

        if(p.oferta){
          const offer = document.createElement("span");
          offer.className = "tag offer";
          offer.style.marginLeft = "8px";
          offer.textContent = "OFERTA";
          left.appendChild(offer);
        }

        const right = document.createElement("div");
        const view = document.createElement("a");
        view.className = "btn ghost small";
        view.href = `producto.html?id=${encodeURIComponent(p.id)}`;
        view.textContent = "Ver";
        right.appendChild(view);

        top.appendChild(left);
        top.appendChild(right);

        const thumbs = document.createElement("div");
        thumbs.className = "thumbs";
        const imgs = Array.isArray(p.imagenes) ? p.imagenes : [];
        imgs.slice(0,4).forEach(src => {
          const im = document.createElement("img");
          im.src = src;
          im.alt = "thumb";
          thumbs.appendChild(im);
        });

        const actions = document.createElement("div");
        actions.className = "actions";

        const btnEdit = document.createElement("button");
        btnEdit.type = "button";
        btnEdit.className = "btn";
        btnEdit.textContent = "Editar";
        btnEdit.onclick = () => {
          editId = p.id;
          $nombre.value = p.nombre || "";
          $categoria.value = p.categoria || "Alarmas";
          $precio.value = p.precio || "";
          $descripcion.value = p.descripcion || "";
          $oferta.checked = !!p.oferta;
          images = Array.isArray(p.imagenes) ? [...p.imagenes] : [];
          renderGallery();
          openModal("edit");
        };

        const btnDel = document.createElement("button");
        btnDel.type = "button";
        btnDel.className = "btn danger";
        btnDel.textContent = "Eliminar";
        btnDel.onclick = () => {
          if(!confirm("¿Eliminar este producto?")) return;
          const next = loadAllProducts().filter(x => x.id !== p.id);
          saveAllProducts(next);
          renderList();
        };

        actions.appendChild(btnEdit);
        actions.appendChild(btnDel);

        item.appendChild(top);
        if(imgs.length) item.appendChild(thumbs);
        item.appendChild(actions);

        $list.appendChild(item);
      }
    }

    $btnSave.addEventListener("click", () => {
      const nombre = ($nombre.value || "").trim();
      if(!nombre){ alert("Poné un nombre de producto."); $nombre.focus(); return; }

      const categoria = $categoria.value;
      const precioRaw = ($precio.value || "").trim();
      const descripcion = ($descripcion.value || "").trim();
      const oferta = !!$oferta.checked;

      const current = loadAllProducts();
      const old = editId ? current.find(x => x.id === editId) : null;

      const payload = normalizeProduct({
        id: editId || uid(),
        nombre, categoria,
        precio: precioRaw ? Number(precioRaw) : "",
        descripcion,
        imagenes: images,
        oferta,
        createdAt: old?.createdAt || Date.now()
      });

      let arr = loadAllProducts();

      if(editId){
        const idx = arr.findIndex(x => x.id === editId);
        if(idx >= 0) arr[idx] = payload;
      } else {
        arr.unshift(payload);
      }

      saveAllProducts(arr);
      renderList();
      closeModal();
    });

    $btnExport.addEventListener("click", () => {
      const arr = loadAllProducts();
      const data = { app:"Segural", version:3, exportedAt:new Date().toISOString(), products:arr };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type:"application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `segural-productos-backup-${new Date().toISOString().slice(0,10)}.json`;
      document.body.appendChild(a);
      a.click(); a.remove();
      URL.revokeObjectURL(url);
    });

    $btnImport.addEventListener("click", () => $importFile.click());

    $importFile.addEventListener("change", async () => {
      const file = $importFile.files && $importFile.files[0];
      if(!file) return;

      try{
        const text = await file.text();
        const parsed = JSON.parse(text);
        const incoming = Array.isArray(parsed) ? parsed : (parsed.products || []);
        if(!Array.isArray(incoming)){ alert("Archivo inválido."); return; }

        const normalized = incoming.map(normalizeProduct).filter(p => p.nombre);

        const current = loadAllProducts();
        const map = new Map(current.map(p => [p.id, p]));
        for(const p of normalized) map.set(p.id, p);

        saveAllProducts(Array.from(map.values()));
        renderList();
        alert("Importación completada ✅");
      }catch(e){
        alert("No se pudo importar. JSON inválido.");
      }finally{
        $importFile.value = "";
      }
    });

    $btnWipe.addEventListener("click", () => {
      if(!confirm("¿Seguro que querés borrar TODOS los productos?")) return;
      localStorage.removeItem(STORAGE_KEY);
      renderList();
    });

    // init
    renderGallery();
    renderList();
  </script>
</body>
</html>
