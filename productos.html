<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Segural | Productos</title>

  <style>
    :root{
      --bg:#ffffff; --muted:#f4f6f8; --text:#101828; --sub:#475467; --line:#e4e7ec;
      --blue:#2b6cb0; --blue2:#0b63ce; --shadow:0 10px 30px rgba(16,24,40,.08); --r:18px;
      --offer:#b54708; --offerBg: rgba(181,71,8,.12);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{
      position:sticky;top:0;z-index:1000;background:rgba(255,255,255,.92);backdrop-filter:blur(10px);
      border-bottom:1px solid var(--line);box-shadow:0 6px 20px rgba(16,24,40,.06);
    }
    .nav-wrap{max-width:1150px;margin:0 auto;padding:14px 18px;display:flex;align-items:center;justify-content:space-between;gap:14px}
    .brand{display:flex;align-items:center;gap:10px;text-decoration:none;color:var(--text);font-weight:800;font-size:20px}
    .brand-badge{width:40px;height:40px;border-radius:14px;background:linear-gradient(135deg,var(--blue),#1f3c88);
      box-shadow:0 10px 20px rgba(43,108,176,.25);display:grid;place-items:center;color:#fff;font-weight:900}
    nav{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .nav-link{text-decoration:none;color:var(--sub);padding:10px 12px;border-radius:12px;border:1px solid transparent;transition:.2s ease;font-weight:700;font-size:14px}
    .nav-link:hover{color:var(--text);background:var(--muted);border-color:var(--line)}
    .nav-link.primary{color:#fff;background:linear-gradient(135deg,var(--blue2),var(--blue));border-color:rgba(43,108,176,.25);box-shadow:0 10px 20px rgba(11,99,206,.20)}

    .container{max-width:1150px;margin:0 auto;padding:26px 18px 90px}
    .top{padding:22px;border:1px solid var(--line);border-radius:var(--r);background:linear-gradient(180deg,#ffffff,#fafbfc);box-shadow:var(--shadow);position:relative;overflow:hidden}
    .top::before{content:"";position:absolute;inset:-120px -120px auto auto;width:260px;height:260px;background:radial-gradient(circle,rgba(43,108,176,.18),rgba(43,108,176,0) 60%);pointer-events:none}
    h1{margin:0 0 8px 0;font-size:28px}
    p{margin:0;color:var(--sub);line-height:1.6}

    .controls{margin-top:16px;display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .input,.select{padding:12px 12px;border-radius:14px;border:1px solid var(--line);background:#fff;min-width:220px;outline:none;box-shadow:0 6px 16px rgba(16,24,40,.05)}
    .btn{padding:12px 14px;border-radius:14px;border:1px solid rgba(11,99,206,.20);background:rgba(11,99,206,.08);color:var(--blue2);font-weight:900;cursor:pointer;transition:.2s ease}
    .btn:hover{transform:translateY(-1px);filter:brightness(1.02)}

    .tabs{margin-top:14px;display:flex;gap:10px;flex-wrap:wrap}
    .tab{
      border:1px solid var(--line);background:#fff;border-radius:999px;padding:10px 12px;
      font-weight:900;color:#344054;cursor:pointer;transition:.2s;
      display:inline-flex;align-items:center;gap:8px;
    }
    .tab:hover{background:var(--muted);transform:translateY(-1px)}
    .tab.active{
      background:linear-gradient(135deg,var(--blue2),var(--blue));
      color:#fff;border-color:rgba(43,108,176,.25);
      box-shadow:0 10px 20px rgba(11,99,206,.18);
    }
    .count{
      display:inline-block;padding:4px 9px;border-radius:999px;border:1px solid var(--line);
      background:var(--muted);font-weight:900;font-size:12px;color:#344054;
    }
    .tab.active .count{background:rgba(255,255,255,.18);border-color:rgba(255,255,255,.28);color:#fff}

    .grid{margin-top:18px;display:grid;grid-template-columns:repeat(12,1fr);gap:14px}
    .card{grid-column:span 4;border:1px solid var(--line);border-radius:18px;background:#fff;box-shadow:0 10px 25px rgba(16,24,40,.06);overflow:hidden;display:flex;flex-direction:column;position:relative}
    .thumb{height:170px;background:linear-gradient(180deg,#f7f9fc,#ffffff);border-bottom:1px solid var(--line);display:grid;place-items:center}
    .thumb img{max-width:100%;max-height:100%;object-fit:cover}
    .thumb .noimg{color:var(--sub);font-weight:800;border:1px dashed var(--line);padding:10px 12px;border-radius:14px;background:#fff}
    .content{padding:14px}
    .title{font-weight:900;margin:0 0 6px 0}
    .meta{color:var(--sub);font-size:13.5px;line-height:1.5;margin:0 0 10px 0}
    .price{display:inline-block;font-weight:900;padding:8px 10px;border-radius:12px;border:1px solid var(--line);background:var(--muted);margin-bottom:10px}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .buy{text-decoration:none;display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:14px;background:#25D366;color:#fff;font-weight:900;box-shadow:0 12px 26px rgba(0,0,0,.12)}
    .ghost{text-decoration:none;padding:10px 12px;border-radius:14px;border:1px solid var(--line);background:#fff;color:var(--text);font-weight:900}

    .offer-badge{
      position:absolute;top:12px;left:12px;background:var(--offerBg);color:var(--offer);
      border:1px solid rgba(181,71,8,.25);font-weight:900;padding:8px 10px;border-radius:999px;
      backdrop-filter: blur(6px);
    }

    .empty{margin-top:16px;padding:16px;border:1px solid var(--line);border-radius:18px;background:var(--muted);color:var(--sub);font-weight:900}
    @media (max-width:980px){.card{grid-column:span 6}}
    @media (max-width:620px){.card{grid-column:span 12}.input,.select{min-width:100%}}
  </style>
</head>

<body>
  <header>
    <div class="nav-wrap">
      <a class="brand" href="index.html">
        <span class="brand-badge">S</span><span>Segural</span>
      </a>
      <nav>
        <a class="nav-link" href="index.html">Inicio</a>
        <a class="nav-link primary" href="productos.html">Productos</a>
        <a class="nav-link" href="admin.html">Admin</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="top">
      <h1>Productos</h1>
      <p>Filtrá por categoría, buscá y ordená como quieras.</p>

      <div class="controls">
        <input id="q" class="input" type="search" placeholder="Buscar..." />
        <select id="sort" class="select">
          <option value="new">Orden: Más nuevo</option>
          <option value="price_asc">Precio: Menor a mayor</option>
          <option value="price_desc">Precio: Mayor a menor</option>
          <option value="cat">Categoría</option>
          <option value="name">Nombre</option>
        </select>
        <button class="btn" id="btnReset" type="button">Limpiar</button>
      </div>

      <div class="tabs" id="tabs"></div>
    </section>

    <div id="list" class="grid"></div>
    <div id="empty" class="empty" style="display:none;">No hay productos para mostrar.</div>
  </main>

  <script>
    // ====== STORAGE (con migración automática) ======
    const STORAGE_KEY = "segural_products_v3";
    const LEGACY_KEYS = ["segural_products_v2", "segural_products_v1"];

    function safeParse(raw){
      try { return raw ? JSON.parse(raw) : []; } catch { return []; }
    }

    function uid(){
      if (crypto && crypto.randomUUID) return crypto.randomUUID();
      return String(Date.now()) + Math.random().toString(16).slice(2);
    }

    function normalizeProduct(obj){
      const imagenes = Array.isArray(obj.imagenes) ? obj.imagenes : (obj.imagen ? [obj.imagen] : []);
      return {
        id: obj.id || uid(),
        nombre: String(obj.nombre || "").trim(),
        categoria: String(obj.categoria || "Otros"),
        precio: (obj.precio === "" || obj.precio === null || obj.precio === undefined) ? "" : Number(obj.precio),
        descripcion: String(obj.descripcion || ""),
        imagenes: imagenes.filter(Boolean),
        oferta: !!obj.oferta,
        createdAt: obj.createdAt || Date.now()
      };
    }

    function loadAllProducts(){
      const v3 = safeParse(localStorage.getItem(STORAGE_KEY));
      if (Array.isArray(v3) && v3.length) return v3;

      for (const k of LEGACY_KEYS){
        const legacy = safeParse(localStorage.getItem(k));
        if (Array.isArray(legacy) && legacy.length){
          const migrated = legacy.map(normalizeProduct).filter(p => p.nombre);
          localStorage.setItem(STORAGE_KEY, JSON.stringify(migrated));
          return migrated;
        }
      }
      return [];
    }

    // ====== UI ======
    const WHATSAPP_NUMBER = "5491155034755";
    const $tabs = document.getElementById("tabs");
    const $list = document.getElementById("list");
    const $empty = document.getElementById("empty");
    const $q = document.getElementById("q");
    const $sort = document.getElementById("sort");
    const $btnReset = document.getElementById("btnReset");

    let selectedCat = "Todas";

    function moneyARS(value){
      const n = Number(value || 0);
      return n.toLocaleString("es-AR", { style: "currency", currency: "ARS", maximumFractionDigits: 0 });
    }

    function getImages(p){
      if(Array.isArray(p.imagenes) && p.imagenes.length) return p.imagenes;
      if(p.imagen) return [p.imagen];
      return [];
    }

    function mainImage(p){
      return getImages(p)[0] || "";
    }

    function buildWhatsAppLink(p){
      const priceTxt = p.precio ? (" - " + moneyARS(p.precio)) : " - Consultar precio";
      const text = `Hola Segural, quiero consultar por: ${p.nombre}${priceTxt}. Categoria: ${p.categoria}.`;
      return `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(text)}`;
    }

    function countByCategory(all){
      const counts = new Map();
      for(const p of all){
        const c = (p.categoria || "Otros");
        counts.set(c, (counts.get(c) || 0) + 1);
      }
      return counts;
    }

    function buildTabs(all){
      const counts = countByCategory(all);
      const cats = Array.from(counts.keys()).sort((a,b)=>a.localeCompare(b, "es"));

      $tabs.innerHTML = "";

      const makeTab = (label, count) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "tab" + (selectedCat === label ? " active" : "");
        btn.innerHTML = `${label} <span class="count">${count}</span>`;
        btn.onclick = () => { selectedCat = label; apply(); };
        return btn;
      };

      $tabs.appendChild(makeTab("Todas", all.length));
      for(const c of cats) $tabs.appendChild(makeTab(c, counts.get(c)));
    }

    function sortProducts(arr){
      const mode = $sort.value;
      const safePrice = (p) => (p.precio === "" || p.precio === null || p.precio === undefined) ? null : Number(p.precio);

      const byNew = (a,b) => (Number(b.createdAt||0) - Number(a.createdAt||0));
      const byName = (a,b) => String(a.nombre||"").localeCompare(String(b.nombre||""), "es");
      const byCat = (a,b) => String(a.categoria||"").localeCompare(String(b.categoria||""), "es") || byName(a,b);

      const byPriceAsc = (a,b) => {
        const pa = safePrice(a), pb = safePrice(b);
        if(pa === null && pb === null) return byNew(a,b);
        if(pa === null) return 1;
        if(pb === null) return -1;
        return pa - pb;
      };
      const byPriceDesc = (a,b) => {
        const pa = safePrice(a), pb = safePrice(b);
        if(pa === null && pb === null) return byNew(a,b);
        if(pa === null) return 1;
        if(pb === null) return -1;
        return pb - pa;
      };

      const copy = [...arr];
      if(mode === "new") copy.sort(byNew);
      else if(mode === "price_asc") copy.sort(byPriceAsc);
      else if(mode === "price_desc") copy.sort(byPriceDesc);
      else if(mode === "cat") copy.sort(byCat);
      else if(mode === "name") copy.sort(byName);

      return copy;
    }

    function render(products){
      $list.innerHTML = "";
      if(!products.length){
        $empty.style.display = "block";
        return;
      }
      $empty.style.display = "none";

      for(const p of products){
        const card = document.createElement("article");
        card.className = "card";

        if(p.oferta){
          const badge = document.createElement("div");
          badge.className = "offer-badge";
          badge.textContent = "OFERTA";
          card.appendChild(badge);
        }

        const thumb = document.createElement("div");
        thumb.className = "thumb";

        const imgSrc = mainImage(p);
        if(imgSrc){
          const img = document.createElement("img");
          img.src = imgSrc;
          img.alt = p.nombre || "Producto";
          thumb.appendChild(img);
        }else{
          const no = document.createElement("div");
          no.className = "noimg";
          no.textContent = "Sin imagen";
          thumb.appendChild(no);
        }

        const content = document.createElement("div");
        content.className = "content";

        const title = document.createElement("p");
        title.className = "title";
        title.textContent = p.nombre || "Producto";

        const meta = document.createElement("p");
        meta.className = "meta";
        meta.textContent = `${p.categoria || "Sin categoría"} • ${p.descripcion || "Sin descripción"}`;

        const price = document.createElement("span");
        price.className = "price";
        price.textContent = p.precio ? moneyARS(p.precio) : "Consultar precio";

        const actions = document.createElement("div");
        actions.className = "actions";

        const view = document.createElement("a");
        view.className = "ghost";
        view.href = `producto.html?id=${encodeURIComponent(p.id)}`;
        view.textContent = "Ver producto";

        const buy = document.createElement("a");
        buy.className = "buy";
        buy.href = buildWhatsAppLink(p);
        buy.target = "_blank";
        buy.rel = "noopener";
        buy.textContent = "WhatsApp";

        actions.appendChild(view);
        actions.appendChild(buy);

        content.appendChild(title);
        content.appendChild(meta);
        content.appendChild(price);
        content.appendChild(actions);

        card.appendChild(thumb);
        card.appendChild(content);

        $list.appendChild(card);
      }
    }

    function apply(){
      const all = loadAllProducts();
      buildTabs(all);

      const q = ($q.value || "").trim().toLowerCase();
      let filtered = all;

      if(selectedCat !== "Todas"){
        filtered = filtered.filter(p => (p.categoria || "Otros") === selectedCat);
      }

      if(q){
        filtered = filtered.filter(p => {
          const t = `${p.nombre||""} ${p.descripcion||""} ${p.categoria||""}`.toLowerCase();
          return t.includes(q);
        });
      }

      filtered = sortProducts(filtered);
      render(filtered);
    }

    $q.addEventListener("input", apply);
    $sort.addEventListener("change", apply);
    $btnReset.addEventListener("click", () => {
      $q.value = "";
      $sort.value = "new";
      selectedCat = "Todas";
      apply();
    });

    apply();
  </script>
</body>
</html>
